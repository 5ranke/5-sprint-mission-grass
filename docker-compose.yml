version: "3.9"

services:
  file-management-app:
    build: .
    ports: ["${APP_PORT:-8080}:8080"]
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-dev}

      # 스토리지 스위치 -> 파일 저장 방식
      STORAGE_TYPE: ${STORAGE_TYPE:-s3}
      STORAGE_LOCAL_ROOT_PATH: ${STORAGE_LOCAL_ROOT_PATH:-.discodeit/storage}

      # Spring 표준 DS 키(이름 유지)
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL}
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}

      # (과제 예시 변수 - 필요 없으면 삭제해도 됨)
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}

      # S3 설정 (application.yaml 매핑)
      AWS_S3_ACCESS_KEY: ${AWS_S3_ACCESS_KEY}
      AWS_S3_SECRET_KEY: ${AWS_S3_SECRET_KEY}
      AWS_S3_REGION: ${AWS_S3_REGION}
      AWS_S3_BUCKET: ${AWS_S3_BUCKET}
      AWS_S3_PRESIGNED_URL_EXPIRATION: ${AWS_S3_PRESIGNED_URL_EXPIRATION:-600}

    volumes:
      - app-storage:/opt/app/storage
      # 컨테이너 안의 /opt/app/storage 경로를 app-storage라는 도커 볼륨에 연결
      # 컨테이너가 삭제되어도 파일은 유지 (영구 저장소 역할)
    depends_on:
      - db
    restart: always

  db:
    image: postgres:17.6
    ports: ["${DB_PORT:-5432}:5432"]
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - dbdata:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d:ro
      # ./db/init: 초기 SQL 스크립트를 담은 폴더를 컨테이너에 읽기 전용(ro)으로 연결.
      #  → 앱 실행 시 자동으로 초기 테이블이나 샘플 데이터가 세팅돼요.

volumes:
  app-storage: # 앱 파일
  dbdata: # PostgreSQL 데이터 저장소

#
